#!/usr/bin/env python
# coding=utf-8

## @package biopredyn
## $Author$
## $Date$
## $Copyright: 2014, The CoSMo Company, All Rights Reserved $
## $License: BSD 3-Clause $
## $Revision$

import os
import unittest
import numpy as np
from matplotlib import pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
import libsbml
import libsedml
import libnuml
from biopredyn import model, workflow, result, resources

## Base class for BioPreDyn test cases.
class GenericTestCase(unittest.TestCase):
  
  def setUp(self):
    self.manager = resources.ResourceManager()

## GenericTestCase derived class for SBML related tests.
class SBMLTestCase(GenericTestCase):
  
  def test_local_import(self):
    local = os.path.abspath('FEBS_antimony.xml')
    mod = model.Model(self.manager, source=local)
    self.assertTrue(mod.check())
  
  def test_server_import(self):
    mod = model.Model(self.manager,
      source='https://raw.githubusercontent.com/TheCoSMoCompany/biopredyn/master/Prototype/scripts/FEBS_antimony.xml')
    self.assertTrue(mod.check())
  
  def test_biomodels_import(self):
    mod = model.Model(self.manager,
      source='urn:miriam:biomodels.db:BIOMD0000000001')
    self.assertTrue(mod.check())
  
  def test_write_model(self):
    mod = model.Model(self.manager,
      source=os.path.abspath('FEBS_antimony.xml'))
    mod.write_sbml('${CMAKE_CURRENT_BINARY_DIR}/test_write_model.xml')

## GenericTestCase derived class for SED-ML related tests.
class SEDMLTestCase(GenericTestCase):

  def test_copasi_time_course(self):
    flow = workflow.WorkFlow('test_graphical_output.xml', self.manager)
    flow.get_task_by_id('task_1').set_tool('copasi')
    flow.run_tasks()
    self.assertEqual(
      len(flow.get_task_by_id('task_1').get_result().get_quantities_per_species('C')), 201)
  
  def test_libsbmlsim_time_course(self):
    flow = workflow.WorkFlow('test_graphical_output.xml', self.manager)
    flow.run_tasks()
    self.assertEqual(
      len(flow.get_task_by_id('task_1').get_result().get_time_steps()), 201)

## GenericTestCase derived class for Output related tests
class OutputTestCase(GenericTestCase):
  
  def test_graphical_output(self):
    flow = workflow.WorkFlow('test_graphical_output.xml', self.manager)
    flow.run_tasks()
    flow.process_outputs(test=True)
  
  def test_3D_graphical_output(self):
    flow = workflow.WorkFlow('test_3D_graphical_output.xml', self.manager)
    flow.run_tasks()
    flow.process_outputs(test=True)
  
  def test_csv_report(self):
    flow = workflow.WorkFlow('test_report.xml', self.manager)
    flow.run_tasks()
    flow.process_outputs(test=True,
      filename='${CMAKE_CURRENT_BINARY_DIR}/test_output.csv')
  
  def test_numl_report(self):
    flow = workflow.WorkFlow('test_report.xml', self.manager)
    flow.run_tasks()
    flow.process_outputs(test=True,
      filename='${CMAKE_CURRENT_BINARY_DIR}/test_output.xml')

## GenericTestCase derived class for Result related tests
class ResultTestCase(GenericTestCase):
  
  def test_csv_import(self):
    res = result.Result()
    res.import_from_csv_file('3D_data.csv', self.manager)
  
  def test_numl_import(self):
    res = result.Result()
    res.import_from_numl_file('FEBS_numerical_data.xml', self.manager)
  
  def test_csv_import_time_series(self):
    res = result.TimeSeries()
    res.import_from_csv_file('time_series_data.csv', self.manager)
  
  def test_numl_import_time_series(self):
    res = result.TimeSeries()
    res.import_from_numl_file('FEBS_numerical_data.xml', self.manager)

## GenericTestCase derived class for XPath related tests
class XPathTestCase(GenericTestCase):
  
  def test_unresolved_xpath(self):
    local = os.path.abspath('FEBS_antimony.xml')
    mod = model.Model(self.manager, source=local)
    self.assertRaises(SystemExit, mod.evaluate_xpath,
      '/sbml:sbml/sbml:model/sbml:listOfParameters/sbml:parameter[@id="bad_id"]/@value')
  
  def test_read_value(self):
    local = os.path.abspath('FEBS_antimony.xml')
    mod = model.Model(self.manager, source=local)
    value = mod.evaluate_xpath(
      '/sbml:sbml/sbml:model/sbml:listOfParameters/sbml:parameter[@id="k2"]/@value')
    self.assertEqual(float(value[0]), 0.8)
  
  def test_return_node_list(self):
    local = os.path.abspath('FEBS_antimony.xml')
    mod = model.Model(self.manager, source=local)
    list = mod.evaluate_xpath('//sbml:reaction')
    self.assertEqual(len(list), 3)

## GenericTestCase derived class for Change related tests
class ChangeTestCase(GenericTestCase):
  
  def test_remove_xml(self):
    flow = workflow.WorkFlow('test_remove_xml.xml', self.manager)
    pre_change = flow.get_model_by_id('FEBS').evaluate_xpath('//sbml:species')
    self.assertEqual(len(pre_change), 4)
    flow.get_model_by_id('FEBS').apply_changes()
    post_change = flow.get_model_by_id('FEBS').evaluate_xpath('//sbml:species')
    self.assertEqual(len(post_change), 3)
  
  def test_attribute_value(self):
    flow = workflow.WorkFlow('test_change_attribute.xml', self.manager)
    flow.get_model_by_id('FEBS').apply_changes()
    attr_value = flow.get_model_by_id('FEBS').evaluate_xpath(
      "/sbml:sbml/sbml:model[@id='FEBS']/sbml:listOfSpecies/sbml:species[@id='sp_E']/@initialAmount")
    self.assertEqual(float(attr_value[0]), 1.66058e-05)
  
  def test_compute_value(self):
    flow = workflow.WorkFlow('test_compute_change.xml', self.manager)
    flow.get_model_by_id('FEBS').apply_changes()
    attr_value = flow.get_model_by_id('FEBS').evaluate_xpath(
      "/sbml:sbml/sbml:model[@id='FEBS']/sbml:listOfSpecies/sbml:species[@id='sp_S']/@initialConcentration")
    self.assertEqual(float(attr_value[0]), 1.0e16)
  
  def test_add_xml(self):
    flow = workflow.WorkFlow('test_add_xml.xml', self.manager)
    flow.get_model_by_id('FEBS').apply_changes()
    name = flow.get_model_by_id('FEBS').evaluate_xpath(
      "/sbml:sbml/sbml:model[@id='FEBS']/sbml:listOfSpecies/species[@id='Z']/@name")
    self.assertEqual(str(name[0]), 'fake_species')
  
  def test_change_xml(self):
    flow = workflow.WorkFlow('test_change_xml.xml', self.manager)
    mod = flow.get_model_by_id('FEBS')
    mod.apply_changes()
    name = mod.evaluate_xpath(
      "/sbml:sbml/sbml:model[@id='FEBS']/sbml:listOfSpecies/species[@id='Z']/@name")
    self.assertEqual(str(name[0]), 'fake_species')
    self.assertRaises(SystemExit, mod.evaluate_xpath,
      "/sbml:sbml/sbml:model[@id='FEBS']/sbml:listOfSpecies/sbml:species[@id='sp_P']")

## GenericTestCase derived class for RepeatedTask related tests
class RepeatedTaskTestCase(GenericTestCase):

  def test_uniform_range(self):
    flow = workflow.WorkFlow('test_repeated_task_uniform.xml', self.manager)
    flow.get_task_by_id("task_2").run(True)
    flow.process_outputs(test=True)

  def test_vector_range(self):
    flow = workflow.WorkFlow('test_repeated_task_vector.xml', self.manager)
    flow.get_task_by_id("task_2").run(True)
    flow.process_outputs(test=True)

  def test_functional_range(self):
    flow = workflow.WorkFlow('test_repeated_task_functional.xml', self.manager)
    flow.get_task_by_id("task_2").run(True)
    flow.process_outputs(test=True)

## GenericTestCase derived class for OneStep simulation related tests
class OneStepTestCase(GenericTestCase):

  def test_one_step(self):
    flow = workflow.WorkFlow('test_one_step.xml', self.manager)
    task = flow.get_task_by_id("task_2")
    task.run(True)
    wf.process_outputs()

## GenericTestCase derived class for SteadyState simulation related tests
class SteadyStateTestCase(GenericTestCase):

  def test_fba_cobrapy(self):
    flow = workflow.WorkFlow('test_fba_cobrapy.xml', self.manager)
    task = flow.get_task_by_id("task_1")
    task.run(True)
    self.assertEqual(
      round(task.get_result().get_result()['growth_rate'][0], 2),
      0.38)

  def test_fba_libfbc(self):
    flow = workflow.WorkFlow('test_fba_libfbc.xml', self.manager)
    task = flow.get_task_by_id("task_1")
    task.set_tool('libfbc')
    task.run(True)
    self.assertEqual(
      round(task.get_result().get_result()['growth_rate'][0], 2),
      0.38)

## GenericTestCase derived class for artificial data generation related test.
class DataGenerationTestCase(GenericTestCase):

  def test_homoscedastic_csv(self):
    flow = workflow.WorkFlow('test_data_generation.xml', self.manager)
    task = flow.get_tasks()[0]
    task.set_tool('copasi')
    flow.get_tasks()[1].run(True)
    report = flow.get_outputs()[0]
    report.write_as_csv('homoscedastic_gen.csv', artificial=True,
      noise_type='homoscedastic', std_dev=0.1)
    noised_res = result.TimeSeries()
    noised_res.import_from_csv_file('homoscedastic_gen.csv', self.manager)
    pure_res = task.get_result()
    noised_data = noised_res.get_quantities_per_species('sp_C')
    pure_data = pure_res.get_quantities_per_species('sp_C')
    residuals = noised_data - pure_data
    self.assertEqual(round(residuals.std(), 1), 0.1)

  def test_heteroscedastic_csv(self):
    flow = workflow.WorkFlow('test_data_generation.xml', self.manager)
    task = flow.get_tasks()[0]
    task.set_tool('copasi')
    flow.get_tasks()[1].run(True)
    report = flow.get_outputs()[0]
    report.write_as_csv('heteroscedastic_gen.csv', artificial=True,
      noise_type='heteroscedastic', std_dev=0.1)
    noised_res = result.TimeSeries()
    noised_res.import_from_csv_file('heteroscedastic_gen.csv', self.manager)
    pure_res = task.get_result()
    noised_data = noised_res.get_quantities_per_species('sp_C')
    pure_data = pure_res.get_quantities_per_species('sp_C')
    residuals = noised_data - pure_data
    self.assertNotEqual(residuals.std(), 0.0)

  def test_homoscedastic_numl(self):
    flow = workflow.WorkFlow('test_data_generation.xml', self.manager)
    task = flow.get_tasks()[0]
    task.set_tool('copasi')
    flow.get_tasks()[1].run(True)
    report = flow.get_outputs()[0]
    report.write_as_numl('homoscedastic_gen.xml', artificial=True,
      noise_type='homoscedastic', std_dev=0.1)
    noised_res = result.TimeSeries()
    noised_res.import_from_numl_file('homoscedastic_gen.xml', self.manager)
    pure_res = task.get_result()
    noised_data = noised_res.get_quantities_per_species('sp_C')
    pure_data = pure_res.get_quantities_per_species('sp_C')
    residuals = noised_data - pure_data
    self.assertEqual(round(residuals.std(), 1), 0.1)

  def test_heteroscedastic_numl(self):
    flow = workflow.WorkFlow('test_data_generation.xml', self.manager)
    task = flow.get_tasks()[0]
    task.set_tool('copasi')
    flow.get_tasks()[1].run(True)
    report = flow.get_outputs()[0]
    report.write_as_numl('heteroscedastic_gen.xml', artificial=True,
      noise_type='heteroscedastic', std_dev=0.1)
    noised_res = result.TimeSeries()
    noised_res.import_from_numl_file('heteroscedastic_gen.xml', self.manager)
    pure_res = task.get_result()
    noised_data = noised_res.get_quantities_per_species('sp_C')
    pure_data = pure_res.get_quantities_per_species('sp_C')
    residuals = noised_data - pure_data
    self.assertNotEqual(residuals.std(), 0.0)

## GenericTestCase derived class for parameter estimation related test.
class ParameterEstimationTestCase(GenericTestCase):

  def test_parameter_estimation(self):
    print "TODO" # TODO

if __name__ == '__main__':
    unittest.main()
